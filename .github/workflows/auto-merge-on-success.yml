# Create this file at .github/workflows/auto-merge-on-success.yml
on:
  workflow_run:
    workflows: ["NEON Monthly Update (Parallel)"]
    types: ["completed"]

jobs:
  auto-merge:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Find and merge PR for workflow run branch
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const run = context.payload.workflow_run;
            const headBranch = run.head_branch; // e.g., parallel-2025-10
            if (!headBranch) {
              core.info("No head_branch found on workflow_run payload; nothing to do.");
              return;
            }
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            core.info(`Searching for open PR with head ${owner}:${headBranch}`);

            const prs = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              per_page: 100
            });

            const pr = prs.data.find(p => p.head && p.head.ref === headBranch && p.head.repo && p.head.repo.full_name.toLowerCase() === `${owner}/${repo}`.toLowerCase());

            if (!pr) {
              core.info(`No open PR found for branch ${headBranch}`);
              return;
            }

            core.info(`Found PR #${pr.number}: ${pr.title} â€” attempting merge`);

            // Merge the PR. Change merge_method to "merge" or "rebase" if you prefer.
            await github.rest.pulls.merge({
              owner,
              repo,
              pull_number: pr.number,
              merge_method: "squash"
            });

            core.info(`Merged PR #${pr.number}`);