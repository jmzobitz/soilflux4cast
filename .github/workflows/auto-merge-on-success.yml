on:
  workflow_run:
    workflows: ["NEON Monthly Update (Parallel)"]
    types: ["completed"]

jobs:
  merge-and-delete:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Merge PR and delete branch
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const run = context.payload.workflow_run;
            const headBranch = run.head_branch;
            if (!headBranch) {
              core.info("No head_branch on workflow_run payload â€” nothing to do.");
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            core.info(`Looking for PR with head ${owner}:${headBranch}`);

            // Try to find an open PR whose head is the branch
            const prsOpen = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              per_page: 100
            });

            let pr = prsOpen.data.find(p =>
              p.head && p.head.ref === headBranch &&
              p.head.repo && p.head.repo.full_name.toLowerCase() === `${owner}/${repo}`.toLowerCase()
            );

            // If no open PR, look for a recently-closed merged PR for the branch
            if (!pr) {
              const prsClosed = await github.rest.pulls.list({
                owner,
                repo,
                state: "closed",
                per_page: 100
              });
              pr = prsClosed.data.find(p =>
                p.head && p.head.ref === headBranch &&
                p.head.repo && p.head.repo.full_name.toLowerCase() === `${owner}/${repo}`.toLowerCase() &&
                p.merged_at
              );
            }

            if (!pr) {
              core.info(`No PR found (open or merged) for branch ${headBranch}; nothing to do.`);
              return;
            }

            core.info(`Found PR #${pr.number} (state=${pr.state}).`);

            // If PR is still open, merge it
            if (pr.state === "open") {
              try {
                core.info(`Merging PR #${pr.number} using squash...`);
                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: pr.number,
                  merge_method: "squash"
                });
                core.info(`PR #${pr.number} merged.`);
              } catch (err) {
                core.setFailed(`Failed to merge PR #${pr.number}: ${err}`);
                return;
              }
            } else {
              core.info(`PR #${pr.number} already closed (merged_at=${pr.merged_at})`);
            }

            // Delete the branch ref if it still exists
            const ref = `heads/${headBranch}`;
            try {
              await github.rest.git.deleteRef({
                owner,
                repo,
                ref
              });
              core.info(`Deleted branch ref ${ref}`);
            } catch (err) {
              // Non-fatal: branch might already be deleted or protected
              core.info(`Could not delete branch ${headBranch}: ${err.message || err}`);
            }