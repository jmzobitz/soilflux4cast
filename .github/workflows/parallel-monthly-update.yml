name: NEON Monthly Update (Dynamic & Parallel)

on:
  workflow_dispatch:
    inputs:
      month:
        description: "Month to process (YYYY-MM)"
        required: true
        default: "2025-01"

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      month: ${{ steps.get_month.outputs.month }}
    steps:
      - uses: actions/checkout@v3

      - name: Determine month
        id: determine_month
        shell: bash
        run: |
          MONTH="${{ github.event.inputs.month }}"
          if [ -z "$MONTH" ]; then
            MONTH=$(date -d "$(date +%Y-%m-01) -1 month" +%Y-%m)
          fi
          echo "month=$MONTH" >> $GITHUB_OUTPUT


      - name: Get NEON terrestrial sites
        id: get_sites
        run: |
          Rscript --vanilla --quiet -e '
            source("renv/activate.R")
            library(tidyverse)

            d <- readr::read_csv(
              "https://raw.githubusercontent.com/eco4cast/neon4cast-targets/main/NEON_Field_Site_Metadata_20220412.csv",
              show_col_types = FALSE
            )

            terrestrial_sites <- d$field_site_id[d$terrestrial == 1]

            # Convert to JSON array string for matrix
            json <- jsonlite::toJSON(terrestrial_sites, auto_unbox = TRUE)
            writeLines(json, "sites.json")
          '

      - name: Set matrix output
        id: set-matrix
        run: |
          MATRIX=$(cat sites.json)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  process-site:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        site: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - uses: r-lib/actions/setup-r@v2

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdal-dev libproj-dev libgeos-dev

      - name: Restore R packages
        env:
          GITHUB_PAT: ${{ secrets.PAT_TOKEN }}
        run: |
          Rscript -e '
            install.packages("renv", repos="https://cloud.r-project.org")
            source("renv/activate.R")
            renv::restore(
              packages = c("tidyverse", "neonUtilities","neonSoilFlux"),
              prompt = FALSE
            )
          '

      - name: Run single-site processing
        run: |
          MONTH="${{ needs.generate-matrix.outputs.month }}"
          SITE="${{ matrix.site }}"
          echo "Processing site $SITE for month $MONTH"
          if ! Rscript scripts/process_single_site.R "$SITE" "$MONTH"; then
            echo "Warning: $SITE failed or has no output, skipping..."
          fi

      - name: Upload site artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: site-${{ matrix.site }}
          path: |
            data/drivers/neon/soil_drivers-${{ matrix.site }}-${{ needs.generate-matrix.outputs.month }}.csv
            data/targets/neon/forecast_prediction-${{ matrix.site }}-${{ needs.generate-matrix.outputs.month }}.csv

  reduce:
    needs: process-site
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: r-lib/actions/setup-r@v2

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdal-dev libproj-dev libgeos-dev

      - name: Restore only needed R packages
        env:
          GITHUB_PAT: ${{ secrets.PAT_TOKEN }}
        run: |
          Rscript -e '
            install.packages("renv", repos="https://cloud.r-project.org")
            source("renv/activate.R")
            renv::restore(
              packages = c("tidyverse"),
              prompt = FALSE
            )
          '

      - name: Download all site artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "site-*"
          path: .
          merge-multiple: true

      - name: Copy artifacts into final workspace
        run: |
          mkdir -p data/drivers/neon data/targets/neon
          find . -type f -path "*/data/drivers/neon/*" -exec cp -v {} data/drivers/neon/ \; || true
          find . -type f -path "*/data/targets/neon/*" -exec cp -v {} data/targets/neon/ \; || true
          echo "Workspace contents after merging artifacts:"
          ls -R data

      - name: Combine outputs
        run: |
          MONTH="${{ needs.generate-matrix.outputs.month }}"
          Rscript scripts/combine_month.R "$MONTH"

      - name: Commit combined results
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config --global user.email "zobitz@augsburg.edu"
          git config --global user.name "jmzobitz"
          git checkout main
          git pull origin main
          git add -f data/drivers/neon/* data/targets/neon/* 2>/dev/null || true
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Monthly update for $MONTH"
            git push origin main
          else
            echo "No changes to commit."
