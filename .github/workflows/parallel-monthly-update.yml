name: NEON Monthly Update (Parallel)

on:
  workflow_dispatch:
    inputs:
      month:
        description: "Month to process (YYYY-MM)"
        required: true
        default: "2025-01"

  schedule:
    - cron: "0 10 15 * *"

permissions:
  contents: write
  pull-requests: write

jobs:
  determine-sites:
    runs-on: ubuntu-latest
    outputs:
      sites: ${{ steps.get_sites.outputs.sites }}
    steps:
      - uses: actions/checkout@v3
      - uses: r-lib/actions/setup-r@v2

      - name: Install system dependencies for terra
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdal-dev libproj-dev libgeos-dev

      - name: Restore R packages from renv.lock
        env:
          GITHUB_PAT: ${{ secrets.PAT_TOKEN }}
        run: Rscript -e 'renv::restore(prompt = FALSE)'

      - name: Get list of terrestrial NEON sites
        id: get_sites
        shell: bash
        run: |
          JSON=$(Rscript --vanilla --quiet -e '
            source("renv/activate.R")
            library(tidyverse)
            library(jsonlite)

            d <- readr::read_csv(
              "https://raw.githubusercontent.com/eco4cast/neon4cast-targets/main/NEON_Field_Site_Metadata_20220412.csv",
              show_col_types = FALSE
            )

            terrestrial_sites <- d |> filter(terrestrial == 1) |> pull(field_site_id)

            # Output compact JSON
            cat(jsonlite::toJSON(terrestrial_sites, auto_unbox = TRUE, pretty = FALSE))
          ')

          # Base64-encode JSON for safe output
          ENCODED=$(echo -n "$JSON" | base64 -w 0)

          # Heredoc-safe output
          {
            echo "sites<<EOF"
            echo "$ENCODED"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  decode-sites:
    needs: determine-sites
    runs-on: ubuntu-latest
    outputs:
      sites_decoded: ${{ steps.decode.outputs.sites_decoded }}
    steps:
      - name: Decode Base64 to JSON
        id: decode
        shell: bash
        run: |
          JSON=$(echo "${{ needs.determine-sites.outputs.sites }}" | base64 --decode)

          # Heredoc-safe output
          {
            echo "sites_decoded<<EOF"
            echo "$JSON"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  process-site:
    needs: decode-sites
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        site: ${{ fromJson(needs.decode-sites.outputs.sites_decoded) }}

    steps:
      - uses: actions/checkout@v3
      - uses: r-lib/actions/setup-r@v2

      - name: Install system dependencies for terra
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdal-dev libproj-dev libgeos-dev

      - name: Restore required R packages
        env:
          GITHUB_PAT: ${{ secrets.PAT_TOKEN }}
        run: |
          Rscript -e '
            install.packages("renv", repos="https://cloud.r-project.org")
            source("renv/activate.R")
            renv::restore(
              packages = c("tidyverse", "neonUtilities", "neonSoilFlux"),
              prompt = FALSE
            )
          '

      - name: Determine month
        id: determine_month
        run: |
          if [ -n "${{ github.event.inputs.month }}" ]; then
            echo "month=${{ github.event.inputs.month }}" >> $GITHUB_OUTPUT
          else
            MONTH=$(date -u -d "$(date -u +%Y-%m-01) -1 month" +%Y-%m)
            echo "month=$MONTH" >> $GITHUB_OUTPUT
          fi

      - name: Run single-site processing
        continue-on-error: true
        run: |
          Rscript scripts/process_single_site.R \
            "${{ matrix.site }}" \
            "${{ steps.determine_month.outputs.month }}"

      - name: List files for debugging
        run: ls -R data/drivers/neon data/targets/neon || true

      - name: Upload site artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: site-${{ matrix.site }}
          path: |
            data/drivers/neon/soil_drivers-${{ matrix.site }}-${{ steps.determine_month.outputs.month }}.csv
            data/targets/neon/forecast_prediction-${{ matrix.site }}-${{ steps.determine_month.outputs.month }}.csv

  reduce:
    needs: process-site
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: r-lib/actions/setup-r@v2

      - name: Install system dependencies for terra
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdal-dev libproj-dev libgeos-dev

      - name: Restore minimal R packages
        env:
          GITHUB_PAT: ${{ secrets.PAT_TOKEN }}
        run: |
          Rscript -e '
            install.packages("renv", repos="https://cloud.r-project.org")
            source("renv/activate.R")
            renv::restore(
              packages = c("tidyverse"),
              prompt = FALSE
            )
          '

      - name: Download all site artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: site-*
          path: .
          merge-multiple: true

      - name: Merge downloaded artifacts
        run: |
          for d in site-*; do
            if [ -d "$d/data/drivers/neon" ]; then
              mkdir -p data/drivers/neon
              cp -v "$d"/data/drivers/neon/* data/drivers/neon/ || true
            fi
            if [ -d "$d/data/targets/neon" ]; then
              mkdir -p data/targets/neon
              cp -v "$d"/data/targets/neon/* data/targets/neon/ || true
            fi
          done
          echo "Merged workspace:"
          ls -R data || true

      - name: Determine month
        id: determine_month
        run: |
          if [ -n "${{ github.event.inputs.month }}" ]; then
            echo "month=${{ github.event.inputs.month }}" >> $GITHUB_OUTPUT
          else
            MONTH=$(date -u -d "$(date -u +%Y-%m-01) -1 month" +%Y-%m)
            echo "month=$MONTH" >> $GITHUB_OUTPUT

      - name: Combine outputs
        run: |
          Rscript scripts/combine_month.R "${{ steps.determine_month.outputs.month }}"

      - name: Commit combined results to main
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config --global user.email "zobitz@augsburg.edu"
          git config --global user.name "jmzobitz"

          git checkout main
          git pull origin main

          FILE1="data/drivers/neon_soil_drivers-${{ steps.determine_month.outputs.month }}.csv"
          FILE2="data/targets/neon_targets-${{ steps.determine_month.outputs.month }}.csv"

          git add -f "$FILE1" "$FILE2" 2>/dev/null || true

          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Monthly update for ${{ steps.determine_month.outputs.month }}"
            git push origin main
          else
            echo "No changes to commit."
          fi
