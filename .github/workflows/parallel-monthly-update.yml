name: NEON Monthly Update (Sequential)

on:
  workflow_dispatch:
    inputs:
      month:
        description: "Month to process (YYYY-MM)"
        required: true
        default: "2025-01"

  schedule:
    - cron: "0 10 15 * *"

permissions:
  contents: write
  pull-requests: write

jobs:
  process-sites:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: r-lib/actions/setup-r@v2

      - name: Install system dependencies for terra
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdal-dev libproj-dev libgeos-dev

      - name: Restore R packages from renv.lock
        env:
          GITHUB_PAT: ${{ secrets.PAT_TOKEN }}
        run: Rscript -e 'renv::restore(prompt = FALSE)'

      - name: Determine month
        id: determine_month
        run: |
          if [ -n "${{ github.event.inputs.month }}" ]; then
            echo "month=${{ github.event.inputs.month }}" >> $GITHUB_OUTPUT
          else
            MONTH=$(date -d "$(date +%Y-%m-01) -1 month" +%Y-%m)
            echo "month=$MONTH" >> $GITHUB_OUTPUT
          fi

      - name: Get NEON terrestrial sites
        id: get_sites
        run: |
          Rscript --vanilla --quiet -e '
            source("renv/activate.R")
            library(tidyverse)

            d <- readr::read_csv(
              "https://raw.githubusercontent.com/eco4cast/neon4cast-targets/main/NEON_Field_Site_Metadata_20220412.csv",
              show_col_types = FALSE
            )

            terrestrial_sites <- d$field_site_id[d$terrestrial == 1]

            writeLines(terrestrial_sites, "sites.txt")
          '

      - name: Process each site
        run: |
          MONTH="${{ steps.determine_month.outputs.month }}"
          while read -r SITE; do
            echo "Processing site: $SITE"

            # Run the R script, but don't kill workflow if it fails
            if ! Rscript scripts/process_single_site.R "$SITE" "$MONTH"; then
              echo "Warning: processing failed for $SITE, skipping..."
              continue
            fi

            # Optional: Upload site artifacts if they exist
            DRIVER_FILE="data/drivers/neon/soil_drivers-${SITE}-${MONTH}.csv"
            TARGET_FILE="data/targets/neon/forecast_prediction-${SITE}-${MONTH}.csv"

            if [ -f "$DRIVER_FILE" ] || [ -f "$TARGET_FILE" ]; then
              mkdir -p artifacts/$SITE
              cp -v "$DRIVER_FILE" "$TARGET_FILE" artifacts/$SITE/ || true
            fi

          done < sites.txt

      - name: Merge site artifacts into workspace
        run: |
          for d in artifacts/*; do
            if [ -d "$d" ]; then
              cp -v "$d"/* data/drivers/neon/ 2>/dev/null || true
              cp -v "$d"/* data/targets/neon/ 2>/dev/null || true
            fi
          done
          echo "Workspace contents after merging artifacts:"
          ls -R data

      - name: Combine outputs
        run: |
          MONTH="${{ steps.determine_month.outputs.month }}"
          Rscript scripts/combine_month.R "$MONTH"

      - name: Commit combined results to main
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config --global user.email "zobitz@augsburg.edu"
          git config --global user.name "jmzobitz"

          git checkout main
          git pull origin main

          FILE1="data/drivers/neon_soil_drivers-${{ steps.determine_month.outputs.month }}.csv"
          FILE2="data/targets/neon_targets-${{ steps.determine_month.outputs.month }}.csv"

          git add -f "$FILE1" "$FILE2" 2>/dev/null || true

          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Monthly update for ${{ steps.determine_month.outputs.month }}"
            git push origin main
          else
            echo "No changes to commit."
          fi
