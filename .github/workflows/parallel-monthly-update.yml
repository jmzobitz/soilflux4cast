name: NEON Monthly Update (Parallel)

on:
  workflow_dispatch:
    inputs:
      month:
        description: "Month to process (YYYY-MM)"
        required: true
        default: "2025-01"

permissions:
  contents: write
  pull-requests: write

jobs:
  determine-sites:
    runs-on: ubuntu-latest
    outputs:
      sites: ${{ steps.get_sites.outputs.sites }}
      month: ${{ steps.determine_month.outputs.month }}
    steps:
      - uses: actions/checkout@v4
      - uses: r-lib/actions/setup-r@v2
      
      - name: Get sites and month
        id: get_sites
        run: |
          # 1. Determine Month
          USER_MONTH="${{ github.event.inputs.month }}"
          MONTH=${USER_MONTH:-$(date -d "$(date +%Y-%m-01) -1 month" +%Y-%m)}
          echo "month=$MONTH" >> $GITHUB_OUTPUT

          # 2. Get Sites as JSON
          # We install jsonlite on the fly to keep it lightweight
          SITES=$(Rscript -e '
            install.packages("jsonlite", repos="https://cloud.r-project.org")
            d <- read.csv("https://raw.githubusercontent.com/eco4cast/neon4cast-targets/main/NEON_Field_Site_Metadata_20220412.csv")
            cat(jsonlite::toJSON(d$field_site_id[d$terrestrial == 1]))
          ')
          echo "sites=$SITES" >> $GITHUB_OUTPUT

  process-site:
    needs: determine-sites
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        site: ${{ fromJson(needs.determine-sites.outputs.sites) }}
    steps:
      - uses: actions/checkout@v4
      - uses: r-lib/actions/setup-r@v2
      
      - name: Install System Dependencies
        run: sudo apt-get update && sudo apt-get install -y libgdal-dev libproj-dev libgeos-dev

      - name: Cache R Packages
        uses: actions/cache@v3
        with:
          path: ~/.local/share/renv
          key: ${{ runner.os }}-renv-${{ hashFiles('**/renv.lock') }}
          restore-keys: |
            ${{ runner.os }}-renv-

      - name: Restore and Run
        env:
          GITHUB_PAT: ${{ secrets.PAT_TOKEN }}
        run: |
          Rscript -e '
            source("renv/activate.R")
            renv::restore(packages = c("tidyverse", "neonUtilities","neonSoilFlux"), prompt = FALSE)
            source("scripts/process_single_site.R")
          ' --args "${{ matrix.site }}" "${{ needs.determine-sites.outputs.month }}"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: site-${{ matrix.site }}
          # Path uses wildcards to catch exactly what we need
          path: data/*/neon/*-${{ matrix.site }}-*.csv

  reduce:
    needs: [determine-sites, process-site]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: r-lib/actions/setup-r@v2

      - name: Download all site artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "site-*"
          path: merged_data
          merge-multiple: true

      - name: Combine and Commit
        run: |
          # Move files from the flat download folder to the expected R structure
          mkdir -p data/drivers/neon data/targets/neon
          mv merged_data/soil_drivers-*.csv data/drivers/neon/ 2>/dev/null || true
          mv merged_data/forecast_prediction-*.csv data/targets/neon/ 2>/dev/null || true
          
          MONTH="${{ needs.determine-sites.outputs.month }}"
          Rscript scripts/combine_month.R "$MONTH"
          
          git config --global user.email "zobitz@augsburg.edu"
          git config --global user.name "jmzobitz"
          git add data/
          git diff --quiet && git diff --staged --quiet || (git commit -m "Monthly update $MONTH" && git push)