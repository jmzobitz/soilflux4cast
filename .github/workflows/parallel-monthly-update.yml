name: NEON Monthly Update (Parallel)

on:
  workflow_dispatch:
    inputs:
      month:
        description: "Month to process (YYYY-MM)"
        required: true
        default: "2025-01"
  schedule:
    - cron: "0 10 15 * *"

permissions:
  contents: write
  pull-requests: write

jobs:
  determine-month:
    runs-on: ubuntu-latest
    outputs:
      month: ${{ steps.get_month.outputs.month }}
    steps:
      - name: Determine month
        id: get_month
        run: |
          if [ -n "${{ github.event.inputs.month }}" ]; then
            echo "month=${{ github.event.inputs.month }}" >> $GITHUB_OUTPUT
          else
            MONTH=$(date -d "$(date +%Y-%m-01) -1 month" +%Y-%m)
            echo "month=$MONTH" >> $GITHUB_OUTPUT

  determine-sites:
    runs-on: ubuntu-latest
    outputs:
      sites-file: sites.txt
    steps:
      - uses: actions/checkout@v3

      - name: Get NEON terrestrial sites
        run: |
          Rscript --vanilla --quiet -e '
            source("renv/activate.R")
            library(tidyverse)

            d <- readr::read_csv(
              "https://raw.githubusercontent.com/eco4cast/neon4cast-targets/main/NEON_Field_Site_Metadata_20220412.csv",
              show_col_types = FALSE
            )

            terrestrial_sites <- d$field_site_id[d$terrestrial == 1]

            writeLines(terrestrial_sites, "sites.txt")
          '

      - name: Save sites file for downstream jobs
        uses: actions/upload-artifact@v4
        with:
          name: sites-file
          path: sites.txt

# Dynamically create one job per site
# This uses a composite job generator pattern
# https://docs.github.com/en/actions/using-jobs/using-a-matrix-for-your-jobs
  process-sites:
    needs: [determine-sites, determine-month]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        site: [placeholder]  # will be replaced dynamically in a workflow_dispatch-triggered run
    steps:
      - uses: actions/checkout@v3

      - name: Download sites file
        uses: actions/download-artifact@v4
        with:
          name: sites-file
          path: .

      - name: Read sites into matrix
        id: set-matrix
        run: |
          # Read sites.txt and print as comma-separated list for matrix
          SITES=$(paste -sd "," sites.txt)
          echo "sites_list=$SITES" >> $GITHUB_OUTPUT

      - name: Process each site in parallel
        run: |
          MONTH="${{ needs.determine-month.outputs.month }}"
          while read -r SITE; do
            echo "Running site $SITE"
            # Use continue-on-error logic for each site
            (
              Rscript scripts/process_single_site.R "$SITE" "$MONTH" || \
              echo "Warning: $SITE failed, skipping..."
            ) &
          done < sites.txt
          wait  # wait for all background jobs to finish

      - name: Merge outputs
        run: |
          mkdir -p data/drivers/neon data/targets/neon
          for f in $(find . -path './data/drivers/neon/*' -o -path './data/targets/neon/*'); do
            cp -v "$f" ./data/drivers/neon/ 2>/dev/null || true
            cp -v "$f" ./data/targets/neon/ 2>/dev/null || true
          done
          echo "Workspace contents after merging artifacts:"
          ls -R data

      - name: Combine all site outputs
        run: |
          MONTH="${{ needs.determine-month.outputs.month }}"
          Rscript scripts/combine_month.R "$MONTH"

      - name: Commit combined results
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config --global user.email "zobitz@augsburg.edu"
          git config --global user.name "jmzobitz"
          git checkout main
          git pull origin main
          git add -f data/drivers/neon/* data/targets/neon/* 2>/dev/null || true
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Monthly update for ${{ needs.determine-month.outputs.month }}"
            git push origin main
          else
            echo "No changes to commit."
